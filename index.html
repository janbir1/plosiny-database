<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plošiny Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <style>
        .ghost { opacity: 0.3; background: #d3d2b5 !important; border: 2px dashed #6366f1; }
        .drag-handle { cursor: grab; transition: all 0.2s ease; border-left-width: 6px; touch-action: none; }
        .drag-handle:active { cursor: grabbing; scale: 0.98; }
        #authOverlay { backdrop-filter: blur(12px); z-index: 100; transition: all 0.4s ease; }
        /* Odstranění modrého probliknutí při klepnutí na mobilu */
        .task-card { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen p-2 md:p-10 select-none">

    <div id="authOverlay" class="fixed inset-0 bg-slate-900/95 flex items-center justify-center p-4">
        <div class="bg-slate-800 p-8 rounded-3xl border border-slate-700 shadow-2xl max-w-sm w-full text-center">
            <div class="w-16 h-16 bg-emerald-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
            </div>
            <h2 class="text-2xl font-black uppercase tracking-tight text-white mb-2">Vstup do systému</h2>
            <p class="text-slate-400 text-sm mb-6">Zadejte přístupový PIN</p>
            <input type="password" id="pinInput" inputmode="numeric" pattern="[0-9]*" placeholder="••••" 
                class="bg-slate-900 border border-slate-600 rounded-2xl px-4 py-4 w-full text-center text-3xl tracking-[0.5em] focus:outline-none focus:ring-2 focus:ring-emerald-500 mb-2 text-white font-bold transition-all">
            <p id="errorMsg" class="text-red-500 text-sm h-5 opacity-0 transition-opacity">Nesprávný PIN!</p>
        </div>
    </div>

    <main id="dashboardContent" class="hidden opacity-0 transition-opacity duration-700">
        <header class="max-w-6xl mx-auto mb-6 md:mb-10">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6 text-center md:text-left">
                <div>
                    <h1 class="text-3xl font-black tracking-tight uppercase text-white">Plošiny <span class="text-emerald-500 text-sm align-top">Live</span></h1>
                    <p class="text-slate-400 text-sm">Cloudová správa zakázek</p>
                </div>
                <button onclick="resetBoard()" class="bg-red-900/20 hover:bg-red-600 text-red-500 hover:text-white px-4 py-2 rounded-lg text-xs font-bold transition border border-red-500/30 uppercase tracking-widest">
                    Vymazat vše
                </button>
            </div>

            <div class="bg-slate-800 p-3 md:p-4 rounded-2xl border border-slate-700 flex gap-2 max-w-2xl mx-auto shadow-2xl">
                <input type="text" id="taskInput" placeholder="Název nové zakázky..." 
                    class="bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 w-full focus:outline-none focus:ring-2 focus:ring-emerald-500 transition font-semibold text-white">
                <button onclick="addTask()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 rounded-xl font-bold transition shadow-lg active:scale-95">
                    PŘIDAT
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 max-w-7xl mx-auto">
            <div class="bg-slate-800/40 p-2 rounded-xl border border-slate-700/50">
                <h2 class="text-blue-400 font-bold uppercase tracking-widest text-[10px] mb-3 flex items-center bg-blue-500/10 w-fit px-2 py-1 rounded">
                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span> Objednat
                </h2>
                <div id="col-1" data-next="col-2" data-name="Objednat" data-color="border-blue-500" class="sortable-list space-y-3 min-h-[200px]"></div>
            </div>
            <div class="bg-slate-800/40 p-2 rounded-xl border border-slate-700/50">
                <h2 class="text-yellow-400 font-bold uppercase tracking-widest text-[10px] mb-3 flex items-center bg-yellow-500/10 w-fit px-2 py-1 rounded">
                    <span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span> Domluveno
					</h2>
                <div id="col-2" data-next="col-3" data-name="Domluveno" data-color="border-yellow-500" class="sortable-list space-y-3 min-h-[200px]"></div>
            </div>
            <div class="bg-slate-800/40 p-2 rounded-xl border border-slate-700/50">
                <h2 class="text-purple-400 font-bold uppercase tracking-widest text-[10px] mb-3 flex items-center bg-purple-500/10 w-fit px-2 py-1 rounded">
                    <span class="w-2 h-2 bg-purple-500 rounded-full mr-2"></span> Odvoláno </h2>
                <div id="col-3" data-next="col-4" data-name="Odvoláno" data-color="border-purple-500" class="sortable-list space-y-3 min-h-[200px]"></div>
            </div>
            <div class="bg-slate-800/40 p-2 rounded-xl border border-slate-700/50">
                <h2 class="text-emerald-400 font-bold uppercase tracking-widest text-[10px] mb-3 flex items-center bg-emerald-500/10 w-fit px-2 py-1 rounded">
                    <span class="w-2 h-2 bg-emerald-500 rounded-full mr-2"></span> Odvezeno
                </h2>
                <div id="col-4" data-next="null" data-name="Odvezeno" data-color="border-emerald-500" class="sortable-list space-y-3 min-h-[200px]"></div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const HASHED_PIN = "4a7d1ed414474e4033ac29ccb8653d9b"; 

        const firebaseConfig = {
            apiKey: "AIzaSy...", 
            authDomain: "vase-id.firebaseapp.com",
            databaseURL: "https://vase-id-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "vase-id",
            storageBucket: "vase-id.appspot.com",
            messagingSenderId: "id",
            appId: "app-id"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const boardRef = ref(db, 'board_state');
        const pinInput = document.getElementById('pinInput');
        const textColors = { 'border-blue-500': 'text-blue-400', 'border-yellow-500': 'text-yellow-400', 'border-purple-500': 'text-purple-400', 'border-emerald-500': 'text-emerald-400' };

        // --- MOBILE DOUBLE TAP DETEKCE ---
        let lastTap = 0;
        window.handleTouch = function(e, element) {
            const now = new Date().getTime();
            const timesince = now - lastTap;
            if ((timesince < 300) && (timesince > 0)) {
                handleDoubleClick(element);
                e.preventDefault(); 
            }
            lastTap = now;
        };

        pinInput.addEventListener('input', (e) => {
            if (e.target.value.length === 4) checkPin();
        });

        window.checkPin = function() {
            if (CryptoJS.MD5(pinInput.value).toString() === HASHED_PIN) {
                document.getElementById('authOverlay').classList.add('hidden');
                document.getElementById('dashboardContent').classList.remove('hidden');
                setTimeout(() => document.getElementById('dashboardContent').style.opacity = '1', 50);
                initFirebase();
            } else {
                pinInput.value = "";
            }
        };

        function initFirebase() {
            onValue(boardRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    Object.keys(data).forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.innerHTML = data[id];
                            attachEventsToCards(el);
                        }
                    });
                }
            });
        }

        function attachEventsToCards(column) {
            column.querySelectorAll('.task-card').forEach(card => {
                card.onclick = function() { handleDoubleClick(this); }; // Pro PC
                card.ontouchstart = function(e) { handleTouch(e, this); }; // Pro mobil
            });
        }

        window.handleDoubleClick = function(taskElement) {
            const currentColumn = taskElement.parentElement;
            const nextColumnId = currentColumn.getAttribute('data-next');
            if (nextColumnId && nextColumnId !== "null") {
                const nextColumn = document.getElementById(nextColumnId);
                nextColumn.appendChild(taskElement);
                updateTaskStatus(taskElement, nextColumn);
                saveState();
            }
        };

        window.saveState = function() {
            const state = {};
            document.querySelectorAll('.sortable-list').forEach(l => { state[l.id] = l.innerHTML; });
            set(boardRef, state);
        }

        window.addTask = function() {
            const input = document.getElementById('taskInput');
            const title = input.value.trim();
            if (!title) return;
            const now = new Date();
            const time = `${now.getDate()}.${now.getMonth() + 1}. ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
            const col1 = document.getElementById('col-1');
            const task = document.createElement('div');
            task.className = "task-card bg-slate-700 p-3.5 rounded-xl shadow-md drag-handle border-l-[6px] border-blue-500 transition-all group relative mb-3";
            
            task.onclick = function() { handleDoubleClick(this); };
            task.ontouchstart = function(e) { handleTouch(e, this); };

            task.innerHTML = `
                <button onclick="this.parentElement.remove(); saveState();" class="absolute top-2 right-2 text-slate-500 hover:text-red-400 p-2 md:opacity-0 group-hover:opacity-100 transition">✕</button>
                <div class="font-bold text-slate-100 text-lg leading-tight mb-0.5 pr-6">${title}</div>
                <div class="text-[10px] text-slate-400 uppercase tracking-wider">Vytvořeno: ${time}</div>
                <div class="status-log text-[10px] text-blue-400 font-extrabold uppercase tracking-wider mt-0.5">Stav: Objednat</div>
            `;
            col1.appendChild(task);
            input.value = "";
            saveState();
        }

        window.resetBoard = function() {
            if(confirm("Smazat vše?")) set(boardRef, {}).then(() => location.reload());
        }

        function updateTaskStatus(taskElement, columnElement) {
            const newColor = columnElement.getAttribute('data-color');
            const statusName = columnElement.getAttribute('data-name');
            const statusEl = taskElement.querySelector('.status-log');
            taskElement.classList.remove('border-blue-500', 'border-yellow-500', 'border-purple-500', 'border-emerald-500');
            taskElement.classList.add(newColor);
            if (statusEl) {
                const now = new Date();
                const time = `${now.getDate()}.${now.getMonth() + 1}. ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
                Object.values(textColors).forEach(c => statusEl.classList.remove(c));
                statusEl.classList.add(textColors[newColor]);
                statusEl.textContent = `Stav: ${statusName} (${time})`;
            }
        }

        document.querySelectorAll('.sortable-list').forEach(list => {
            new Sortable(list, {
                group: 'tasks',
                animation: 250,
                ghostClass: 'ghost',
                delay: 100, 
                delayOnTouchOnly: true,
                onEnd: (evt) => {
                    if (evt.from !== evt.to) updateTaskStatus(evt.item, evt.to);
                    saveState();
                }
            });
        });

        document.getElementById('taskInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') addTask(); });
    </script>
</body>
</html>
